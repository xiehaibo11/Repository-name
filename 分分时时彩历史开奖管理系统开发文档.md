# åˆ†åˆ†æ—¶æ—¶å½©å†å²å¼€å¥–ç®¡ç†ç³»ç»Ÿå¼€å‘æ–‡æ¡£

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
å½“å‰ç³»ç»Ÿé‡‡ç”¨24å°æ—¶ä¸é—´æ–­å¼€å¥–æ¨¡å¼ï¼Œ1åˆ†é’Ÿä¸€æœŸã€‚ä¸ºäº†ä¼˜åŒ–æ•°æ®å­˜å‚¨å’Œç³»ç»Ÿæ€§èƒ½ï¼Œéœ€è¦å®ç°å†å²å¼€å¥–å·ç ç®¡ç†åŠŸèƒ½ï¼Œæ¯æ—¥åªä¿ç•™30-50æœŸå†å²å¼€å¥–è®°å½•ã€‚

### 1.2 æ ¸å¿ƒéœ€æ±‚
- **å†å²è®°å½•é™åˆ¶**ï¼šæ¯æ—¥ä¿ç•™30-50æœŸå†å²å¼€å¥–å·ç 
- **è‡ªåŠ¨æ¸…ç†æœºåˆ¶**ï¼šæ¯æ—¥å‡Œæ™¨è‡ªåŠ¨æ¸…ç†è¿‡æœŸå¼€å¥–è®°å½•
- **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿æ¸…ç†è¿‡ç¨‹ä¸å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- **å¯é…ç½®æ€§**ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´ä¿ç•™æœŸæ•°

## 2. ç°çŠ¶åˆ†æ

### 2.1 å½“å‰æ•°æ®åº“ç»“æ„

#### ä¸»è¦è¡¨ç»“æ„
```sql
-- åˆ†åˆ†æ—¶æ—¶å½©æœŸå·è¡¨
ssc_lottery_issues (
    id SERIAL PRIMARY KEY,
    issue_no VARCHAR(50) UNIQUE NOT NULL, -- æœŸå·æ ¼å¼: YYYYMMDDNNN
    issue_date DATE NOT NULL,
    issue_index INTEGER NOT NULL, -- å½“æ—¥æœŸå·ç´¢å¼• (1-1440)
    open_time TIMESTAMP NOT NULL,
    close_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'betting'
);

-- åˆ†åˆ†æ—¶æ—¶å½©å¼€å¥–ç»“æœè¡¨
ssc_lottery_results (
    id SERIAL PRIMARY KEY,
    issue_no VARCHAR(50) UNIQUE NOT NULL,
    issue_date DATE NOT NULL,
    wan_wei INTEGER NOT NULL, -- ä¸‡ä½
    qian_wei INTEGER NOT NULL, -- åƒä½
    bai_wei INTEGER NOT NULL, -- ç™¾ä½
    shi_wei INTEGER NOT NULL, -- åä½
    ge_wei INTEGER NOT NULL, -- ä¸ªä½
    winning_numbers VARCHAR(20) NOT NULL, -- "1,2,3,4,5"
    open_time TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'pending'
);
```

### 2.2 å½“å‰æœåŠ¡æ¶æ„

#### æ ¸å¿ƒæœåŠ¡ç±»
- **SSCLotteryService**: åˆ†åˆ†æ—¶æ—¶å½©æœåŠ¡ç±»
  - å®šæ—¶ä»»åŠ¡ç®¡ç†
  - è‡ªåŠ¨å¼€å¥–åŠŸèƒ½
  - ç³»ç»ŸçŠ¶æ€ç›‘æ§
  - æ—¥å¿—æ¸…ç†ï¼ˆä»…æ¸…ç†ç³»ç»Ÿæ—¥å¿—ï¼Œä¸æ¸…ç†å¼€å¥–è®°å½•ï¼‰

#### å®šæ—¶ä»»åŠ¡
```javascript
// å½“å‰å®šæ—¶ä»»åŠ¡
this.cronJobs.set('generateIssues', cron.schedule('5 0 * * *', async () => {
  await this.generateDailyIssues(); // ç”Ÿæˆå½“æ—¥æœŸå·
}));

this.cronJobs.set('autoDrawing', cron.schedule('* * * * *', async () => {
  await this.checkAndDrawLottery(); // æ¯åˆ†é’Ÿæ£€æŸ¥å¼€å¥–
}));

this.cronJobs.set('cleanLogs', cron.schedule('0 * * * *', async () => {
  await this.cleanupLogs(); // æ¯å°æ—¶æ¸…ç†ç³»ç»Ÿæ—¥å¿—
}));
```


## 3. è§£å†³æ–¹æ¡ˆè®¾è®¡

### 3.1 åŠŸèƒ½è®¾è®¡

#### 3.1.1 å†å²è®°å½•ä¿ç•™ç­–ç•¥
- **ä¿ç•™æœŸæ•°**ï¼š30-50æœŸï¼ˆå¯é…ç½®ï¼‰
- **ä¿ç•™è§„åˆ™**ï¼šæŒ‰å¼€å¥–æ—¶é—´å€’åºä¿ç•™æœ€æ–°çš„NæœŸ
- **æ¸…ç†æ—¶æœº**ï¼šæ¯æ—¥å‡Œæ™¨00:05æ‰§è¡Œæ¸…ç†
- **å®‰å…¨æœºåˆ¶**ï¼šæ¸…ç†å‰å¤‡ä»½é‡è¦æ•°æ®

#### 3.1.2 é…ç½®ç®¡ç†
```sql
-- æ–°å¢ç³»ç»Ÿé…ç½®é¡¹
INSERT INTO ssc_system_config (config_key, config_value, config_type, description) VALUES
('history_retention_count', '40', 'number', 'å†å²å¼€å¥–è®°å½•ä¿ç•™æœŸæ•°'),
('auto_cleanup_enabled', 'true', 'boolean', 'æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†'),
('cleanup_backup_enabled', 'true', 'boolean', 'æ¸…ç†å‰æ˜¯å¦å¤‡ä»½æ•°æ®'),
('cleanup_time_hour', '0', 'number', 'æ¸…ç†æ‰§è¡Œæ—¶é—´ï¼ˆå°æ—¶ï¼‰'),
('cleanup_time_minute', '5', 'number', 'æ¸…ç†æ‰§è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰');
```

### 3.2 æŠ€æœ¯å®ç°æ–¹æ¡ˆ

#### 3.2.1 æ•°æ®åº“å±‚é¢

##### åˆ›å»ºå†å²å¤‡ä»½è¡¨
```sql
-- å†å²å¼€å¥–è®°å½•å¤‡ä»½è¡¨
CREATE TABLE IF NOT EXISTS ssc_lottery_results_archive (
    id SERIAL PRIMARY KEY,
    original_id INTEGER NOT NULL, -- åŸè®°å½•ID
    issue_no VARCHAR(50) NOT NULL,
    issue_date DATE NOT NULL,
    wan_wei INTEGER NOT NULL,
    qian_wei INTEGER NOT NULL,
    bai_wei INTEGER NOT NULL,
    shi_wei INTEGER NOT NULL,
    ge_wei INTEGER NOT NULL,
    winning_numbers VARCHAR(20) NOT NULL,
    open_time TIMESTAMP NOT NULL,
    status VARCHAR(20),
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    archive_reason VARCHAR(100) DEFAULT 'daily_cleanup'
);
```

##### åˆ›å»ºæ¸…ç†å‡½æ•°
```sql
-- å†å²å¼€å¥–è®°å½•æ¸…ç†å‡½æ•°
CREATE OR REPLACE FUNCTION cleanup_ssc_history_records(
    retention_count INTEGER DEFAULT 40,
    enable_backup BOOLEAN DEFAULT true
)
RETURNS TABLE(
    cleaned_count INTEGER,
    backed_up_count INTEGER,
    latest_kept_issue VARCHAR(50),
    oldest_kept_issue VARCHAR(50)
) AS $$
DECLARE
    cleanup_result RECORD;
    backup_count INTEGER := 0;
    delete_count INTEGER := 0;
    latest_issue VARCHAR(50);
    oldest_issue VARCHAR(50);
BEGIN
    -- è·å–éœ€è¦ä¿ç•™çš„æœ€æ–°è®°å½•çš„æœ€å°ID
    SELECT MIN(id), MAX(issue_no), MIN(issue_no)
    INTO cleanup_result.min_keep_id, latest_issue, oldest_issue
    FROM (
        SELECT id, issue_no
        FROM ssc_lottery_results
        WHERE status = 'drawn'
        ORDER BY open_time DESC
        LIMIT retention_count
    ) recent_records;
    
    -- å¦‚æœå¯ç”¨å¤‡ä»½ï¼Œå…ˆå¤‡ä»½è¦åˆ é™¤çš„è®°å½•
    IF enable_backup THEN
        INSERT INTO ssc_lottery_results_archive (
            original_id, issue_no, issue_date, wan_wei, qian_wei, 
            bai_wei, shi_wei, ge_wei, winning_numbers, open_time, status
        )
        SELECT 
            id, issue_no, issue_date, wan_wei, qian_wei,
            bai_wei, shi_wei, ge_wei, winning_numbers, open_time, status
        FROM ssc_lottery_results
        WHERE status = 'drawn' 
          AND id < cleanup_result.min_keep_id;
        
        GET DIAGNOSTICS backup_count = ROW_COUNT;
    END IF;
    
    -- åˆ é™¤è¿‡æœŸè®°å½•
    DELETE FROM ssc_lottery_results
    WHERE status = 'drawn' 
      AND id < cleanup_result.min_keep_id;
    
    GET DIAGNOSTICS delete_count = ROW_COUNT;
    
    -- åŒæ­¥æ¸…ç†æœŸå·è¡¨
    DELETE FROM ssc_lottery_issues
    WHERE issue_no NOT IN (
        SELECT issue_no FROM ssc_lottery_results
    );
    
    -- è¿”å›æ¸…ç†ç»“æœ
    RETURN QUERY SELECT 
        delete_count,
        backup_count,
        latest_issue,
        oldest_issue;
END;
$$ LANGUAGE plpgsql;
```

#### 3.2.2 æœåŠ¡å±‚é¢

##### æ‰©å±•SSCLotteryServiceç±»
```javascript
// åœ¨SSCLotteryServiceä¸­æ·»åŠ å†å²è®°å½•ç®¡ç†åŠŸèƒ½

/**
 * æ¸…ç†å†å²å¼€å¥–è®°å½•
 */
async cleanupHistoryRecords() {
  try {
    await this.logCronTask('cleanup_history', null, 'running', 'å¼€å§‹æ¸…ç†å†å²å¼€å¥–è®°å½•');
    
    // è·å–é…ç½®
    const retentionCount = this.config.historyRetentionCount || 40;
    const backupEnabled = this.config.cleanupBackupEnabled !== false;
    
    // æ‰§è¡Œæ¸…ç†
    const result = await pool.query(
      'SELECT * FROM cleanup_ssc_history_records($1, $2)',
      [retentionCount, backupEnabled]
    );
    
    const cleanupResult = result.rows[0];
    
    console.log(`ğŸ§¹ å†å²è®°å½•æ¸…ç†å®Œæˆ:`, {
      æ¸…ç†è®°å½•æ•°: cleanupResult.cleaned_count,
      å¤‡ä»½è®°å½•æ•°: cleanupResult.backed_up_count,
      ä¿ç•™æœ€æ–°æœŸå·: cleanupResult.latest_kept_issue,
      ä¿ç•™æœ€æ—§æœŸå·: cleanupResult.oldest_kept_issue
    });
    
    await this.logCronTask('cleanup_history', null, 'success', 
      `æ¸…ç†å®Œæˆ: åˆ é™¤${cleanupResult.cleaned_count}æ¡, å¤‡ä»½${cleanupResult.backed_up_count}æ¡`);
    
    return cleanupResult;
    
  } catch (error) {
    console.error('âŒ æ¸…ç†å†å²è®°å½•å¤±è´¥:', error);
    await this.logCronTask('cleanup_history', null, 'failed', error.message);
    throw error;
  }
}

/**
 * è·å–å†å²è®°å½•ç»Ÿè®¡
 */
async getHistoryStats() {
  try {
    const result = await pool.query(`
      SELECT 
        COUNT(*) as total_records,
        COUNT(CASE WHEN status = 'drawn' THEN 1 END) as drawn_records,
        MIN(open_time) as earliest_record,
        MAX(open_time) as latest_record,
        COUNT(CASE WHEN open_time >= CURRENT_DATE THEN 1 END) as today_records
      FROM ssc_lottery_results
    `);
    
    const archiveResult = await pool.query(`
      SELECT 
        COUNT(*) as archived_records,
        MIN(archived_at) as earliest_archive,
        MAX(archived_at) as latest_archive
      FROM ssc_lottery_results_archive
    `);
    
    return {
      current: result.rows[0],
      archive: archiveResult.rows[0]
    };
  } catch (error) {
    console.error('âŒ è·å–å†å²ç»Ÿè®¡å¤±è´¥:', error);
    throw error;
  }
}
```

##### æ·»åŠ å®šæ—¶ä»»åŠ¡
```javascript
// åœ¨start()æ–¹æ³•ä¸­æ·»åŠ å†å²æ¸…ç†å®šæ—¶ä»»åŠ¡
async start() {
  // ... ç°æœ‰ä»£ç  ...
  
  // 5. æ¯æ—¥å‡Œæ™¨æ¸…ç†å†å²å¼€å¥–è®°å½•
  if (this.config.autoCleanupEnabled) {
    const cleanupHour = this.config.cleanupTimeHour || 0;
    const cleanupMinute = this.config.cleanupTimeMinute || 5;
    
    this.cronJobs.set('cleanupHistory', cron.schedule(
      `${cleanupMinute} ${cleanupHour} * * *`, 
      async () => {
        await this.cleanupHistoryRecords();
      }, 
      { scheduled: false }
    ));
  }
  
  // ... ç°æœ‰ä»£ç  ...
}
```

#### 3.2.3 APIæ¥å£

##### ç®¡ç†æ¥å£
```javascript
// backend/routes/admin.js ä¸­æ·»åŠ ç›¸å…³æ¥å£

// è·å–å†å²è®°å½•ç»Ÿè®¡
router.get('/lottery/history-stats', async (req, res) => {
  try {
    const stats = await sscLotteryService.getHistoryStats();
    res.json({
      status: 'success',
      data: stats
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      message: error.message
    });
  }
});

// æ‰‹åŠ¨æ¸…ç†å†å²è®°å½•
router.post('/lottery/cleanup-history', async (req, res) => {
  try {
    const { retentionCount, enableBackup } = req.body;
    
    // å‚æ•°éªŒè¯
    if (retentionCount && (retentionCount < 10 || retentionCount > 100)) {
      return res.status(400).json({
        status: 'error',
        message: 'ä¿ç•™æœŸæ•°å¿…é¡»åœ¨10-100ä¹‹é—´'
      });
    }
    
    const result = await sscLotteryService.cleanupHistoryRecords();
    
    res.json({
      status: 'success',
      message: 'å†å²è®°å½•æ¸…ç†å®Œæˆ',
      data: result
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      message: error.message
    });
  }
});

// è·å–å†å²æ¸…ç†æ—¥å¿—
router.get('/lottery/cleanup-logs', async (req, res) => {
  try {
    const { page = 1, limit = 20 } = req.query;
    
    const result = await pool.query(`
      SELECT task_type, start_time, end_time, duration, status, message
      FROM ssc_cron_logs
      WHERE task_type = 'cleanup_history'
      ORDER BY start_time DESC
      LIMIT $1 OFFSET $2
    `, [limit, (page - 1) * limit]);
    
    res.json({
      status: 'success',
      data: {
        logs: result.rows,
        total: result.rowCount
      }
    });
  } catch (error) {
    res.status(500).json({
      status: 'error',
      message: error.message
    });
  }
});
```

#### 3.2.4 å‰ç«¯ç•Œé¢

##### å†å²ç®¡ç†ç»„ä»¶
```jsx
// frontend/src/components/admin/HistoryManagement.jsx

import React, { useState, useEffect } from 'react';
import { 
  Card, 
  Statistic, 
  Button, 
  Modal, 
  Form, 
  InputNumber, 
  Switch,
  Table,
  message,
  Row,
  Col,
  Alert,
  Progress
} from 'antd';
import { 
  DeleteOutlined, 
  HistoryOutlined, 
  DatabaseOutlined,
  CleaningServicesOutlined
} from '@ant-design/icons';

const HistoryManagement = () => {
  const [stats, setStats] = useState(null);
  const [cleanupLogs, setCleanupLogs] = useState([]);
  const [cleanupModalVisible, setCleanupModalVisible] = useState(false);
  const [loading, setLoading] = useState(false);
  const [form] = Form.useForm();

  useEffect(() => {
    loadHistoryStats();
    loadCleanupLogs();
  }, []);

  const loadHistoryStats = async () => {
    try {
      const response = await adminService.getHistoryStats();
      if (response.status === 'success') {
        setStats(response.data);
      }
    } catch (error) {
      message.error('è·å–å†å²ç»Ÿè®¡å¤±è´¥');
    }
  };

  const loadCleanupLogs = async () => {
    try {
      const response = await adminService.getCleanupLogs();
      if (response.status === 'success') {
        setCleanupLogs(response.data.logs);
      }
    } catch (error) {
      message.error('è·å–æ¸…ç†æ—¥å¿—å¤±è´¥');
    }
  };

  const handleManualCleanup = async (values) => {
    setLoading(true);
    try {
      const response = await adminService.cleanupHistory(values);
      if (response.status === 'success') {
        message.success('å†å²è®°å½•æ¸…ç†å®Œæˆ');
        setCleanupModalVisible(false);
        loadHistoryStats();
        loadCleanupLogs();
      }
    } catch (error) {
      message.error('æ¸…ç†å¤±è´¥: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const columns = [
    {
      title: 'æ‰§è¡Œæ—¶é—´',
      dataIndex: 'start_time',
      key: 'start_time',
      render: (text) => new Date(text).toLocaleString()
    },
    {
      title: 'æ‰§è¡ŒçŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      render: (status) => (
        <Tag color={status === 'success' ? 'green' : 'red'}>
          {status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
        </Tag>
      )
    },
    {
      title: 'æ‰§è¡Œä¿¡æ¯',
      dataIndex: 'message',
      key: 'message'
    },
    {
      title: 'è€—æ—¶',
      dataIndex: 'duration',
      key: 'duration',
      render: (duration) => duration ? `${duration}ç§’` : '-'
    }
  ];

  return (
    <div>
      <Row gutter={[16, 16]}>
        <Col span={6}>
          <Card>
            <Statistic
              title="å½“å‰è®°å½•æ€»æ•°"
              value={stats?.current.total_records || 0}
              prefix={<DatabaseOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="å·²å¼€å¥–è®°å½•"
              value={stats?.current.drawn_records || 0}
              prefix={<HistoryOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="ä»Šæ—¥è®°å½•"
              value={stats?.current.today_records || 0}
              prefix={<CleaningServicesOutlined />}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="å½’æ¡£è®°å½•"
              value={stats?.archive.archived_records || 0}
              prefix={<DeleteOutlined />}
            />
          </Card>
        </Col>
      </Row>

      <Card 
        title="å†å²è®°å½•ç®¡ç†" 
        style={{ marginTop: 16 }}
        extra={
          <Button 
            type="primary" 
            icon={<DeleteOutlined />}
            onClick={() => setCleanupModalVisible(true)}
          >
            æ‰‹åŠ¨æ¸…ç†
          </Button>
        }
      >
        <Alert
          message="å†å²è®°å½•æ¸…ç†è¯´æ˜"
          description="ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨æ¯æ—¥å‡Œæ™¨00:05æ¸…ç†å†å²å¼€å¥–è®°å½•ï¼Œåªä¿ç•™æœ€æ–°çš„30-50æœŸè®°å½•ã€‚æ¸…ç†å‰ä¼šè‡ªåŠ¨å¤‡ä»½æ•°æ®åˆ°å½’æ¡£è¡¨ã€‚"
          type="info"
          showIcon
          style={{ marginBottom: 16 }}
        />

        <Table
          columns={columns}
          dataSource={cleanupLogs}
          rowKey="id"
          pagination={{ pageSize: 10 }}
        />
      </Card>

      <Modal
        title="æ‰‹åŠ¨æ¸…ç†å†å²è®°å½•"
        open={cleanupModalVisible}
        onCancel={() => setCleanupModalVisible(false)}
        footer={null}
      >
        <Form
          form={form}
          layout="vertical"
          onFinish={handleManualCleanup}
          initialValues={{
            retentionCount: 40,
            enableBackup: true
          }}
        >
          <Form.Item
            label="ä¿ç•™æœŸæ•°"
            name="retentionCount"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥ä¿ç•™æœŸæ•°' },
              { type: 'number', min: 10, max: 100, message: 'ä¿ç•™æœŸæ•°å¿…é¡»åœ¨10-100ä¹‹é—´' }
            ]}
          >
            <InputNumber
              min={10}
              max={100}
              style={{ width: '100%' }}
              placeholder="è¯·è¾“å…¥è¦ä¿ç•™çš„å†å²è®°å½•æœŸæ•°"
            />
          </Form.Item>

          <Form.Item
            label="æ¸…ç†å‰å¤‡ä»½"
            name="enableBackup"
            valuePropName="checked"
          >
            <Switch checkedChildren="å¯ç”¨" unCheckedChildren="ç¦ç”¨" />
          </Form.Item>

          <Form.Item>
            <Button 
              type="primary" 
              htmlType="submit" 
              loading={loading}
              block
            >
              ç¡®è®¤æ¸…ç†
            </Button>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default HistoryManagement;
```

## 4. éƒ¨ç½²å®æ–½

### 4.1 æ•°æ®åº“è¿ç§»

#### 4.1.1 åˆ›å»ºè¿ç§»è„šæœ¬
```sql
-- migrations/add_history_management.sql

-- 1. åˆ›å»ºå½’æ¡£è¡¨
CREATE TABLE IF NOT EXISTS ssc_lottery_results_archive (
    id SERIAL PRIMARY KEY,
    original_id INTEGER NOT NULL,
    issue_no VARCHAR(50) NOT NULL,
    issue_date DATE NOT NULL,
    wan_wei INTEGER NOT NULL,
    qian_wei INTEGER NOT NULL,
    bai_wei INTEGER NOT NULL,
    shi_wei INTEGER NOT NULL,
    ge_wei INTEGER NOT NULL,
    winning_numbers VARCHAR(20) NOT NULL,
    open_time TIMESTAMP NOT NULL,
    status VARCHAR(20),
    archived_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    archive_reason VARCHAR(100) DEFAULT 'daily_cleanup'
);

-- 2. æ·»åŠ ç³»ç»Ÿé…ç½®
INSERT INTO ssc_system_config (config_key, config_value, config_type, description) VALUES
('history_retention_count', '40', 'number', 'å†å²å¼€å¥–è®°å½•ä¿ç•™æœŸæ•°'),
('auto_cleanup_enabled', 'true', 'boolean', 'æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¸…ç†'),
('cleanup_backup_enabled', 'true', 'boolean', 'æ¸…ç†å‰æ˜¯å¦å¤‡ä»½æ•°æ®'),
('cleanup_time_hour', '0', 'number', 'æ¸…ç†æ‰§è¡Œæ—¶é—´ï¼ˆå°æ—¶ï¼‰'),
('cleanup_time_minute', '5', 'number', 'æ¸…ç†æ‰§è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰')
ON CONFLICT (config_key) DO NOTHING;

-- 3. åˆ›å»ºæ¸…ç†å‡½æ•°
-- [æ­¤å¤„åŒ…å«å‰é¢å®šä¹‰çš„cleanup_ssc_history_recordså‡½æ•°]

-- 4. åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_ssc_results_archive_issue_no ON ssc_lottery_results_archive(issue_no);
CREATE INDEX IF NOT EXISTS idx_ssc_results_archive_archived_at ON ssc_lottery_results_archive(archived_at);
CREATE INDEX IF NOT EXISTS idx_ssc_results_archive_original_id ON ssc_lottery_results_archive(original_id);
```

#### 4.1.2 æ‰§è¡Œè¿ç§»
```bash
# æ‰§è¡Œæ•°æ®åº“è¿ç§»
psql -U your_username -d your_database -f migrations/add_history_management.sql
```

### 4.2 æœåŠ¡æ›´æ–°

#### 4.2.1 æ›´æ–°æœåŠ¡ä»£ç 
```bash
# é‡å¯æœåŠ¡ä»¥åŠ è½½æ–°é…ç½®
npm run dev
# æˆ–ç”Ÿäº§ç¯å¢ƒ
pm2 restart backend
```

#### 4.2.2 éªŒè¯åŠŸèƒ½
```bash
# æµ‹è¯•æ¸…ç†åŠŸèƒ½
curl -X POST http://localhost:3000/api/admin/lottery/cleanup-history \
  -H "Content-Type: application/json" \
  -d '{"retentionCount": 40, "enableBackup": true}'

# æŸ¥çœ‹å†å²ç»Ÿè®¡
curl http://localhost:3000/api/admin/lottery/history-stats
```

### 4.3 ç›‘æ§é…ç½®

#### 4.3.1 æ—¥å¿—ç›‘æ§
```javascript
// åœ¨ç³»ç»Ÿç›‘æ§ä¸­æ·»åŠ å†å²æ¸…ç†ç›‘æ§
const checkHistoryCleanup = async () => {
  const result = await pool.query(`
    SELECT COUNT(*) as total_records
    FROM ssc_lottery_results
    WHERE status = 'drawn'
  `);
  
  const totalRecords = parseInt(result.rows[0].total_records);
  const threshold = 100; // è¶…è¿‡100æœŸè®°å½•æ—¶å‘Šè­¦
  
  if (totalRecords > threshold) {
    console.warn(`âš ï¸ å†å²è®°å½•è¿‡å¤š: ${totalRecords} æœŸï¼Œå»ºè®®æ£€æŸ¥æ¸…ç†ä»»åŠ¡`);
  }
};
```

## 5. æµ‹è¯•æ–¹æ¡ˆ

### 5.1 å•å…ƒæµ‹è¯•

#### 5.1.1 æ¸…ç†åŠŸèƒ½æµ‹è¯•
```javascript
// tests/sscLotteryService.test.js

describe('å†å²è®°å½•æ¸…ç†åŠŸèƒ½', () => {
  test('åº”è¯¥æ­£ç¡®æ¸…ç†å†å²è®°å½•', async () => {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    await createTestRecords(100);
    
    // æ‰§è¡Œæ¸…ç†
    const result = await sscLotteryService.cleanupHistoryRecords();
    
    // éªŒè¯ç»“æœ
    expect(result.cleaned_count).toBe(60); // ä¿ç•™40æœŸï¼Œæ¸…ç†60æœŸ
    expect(result.backed_up_count).toBe(60);
    
    // éªŒè¯æ•°æ®åº“çŠ¶æ€
    const remainingCount = await countRemainingRecords();
    expect(remainingCount).toBe(40);
  });
  
  test('åº”è¯¥æ­£ç¡®å¤„ç†è¾¹ç•Œæƒ…å†µ', async () => {
    // æµ‹è¯•è®°å½•æ•°å°‘äºä¿ç•™æ•°çš„æƒ…å†µ
    await createTestRecords(20);
    
    const result = await sscLotteryService.cleanupHistoryRecords();
    
    expect(result.cleaned_count).toBe(0);
    expect(result.backed_up_count).toBe(0);
  });
});
```

### 5.2 é›†æˆæµ‹è¯•

#### 5.2.1 å®šæ—¶ä»»åŠ¡æµ‹è¯•
```javascript
// éªŒè¯å®šæ—¶ä»»åŠ¡æ˜¯å¦æ­£ç¡®æ‰§è¡Œ
const testScheduledCleanup = async () => {
  // æ¨¡æ‹Ÿå®šæ—¶ä»»åŠ¡æ‰§è¡Œ
  await sscLotteryService.cleanupHistoryRecords();
  
  // éªŒè¯æ—¥å¿—è®°å½•
  const logs = await getCronLogs('cleanup_history');
  expect(logs.length).toBeGreaterThan(0);
  expect(logs[0].status).toBe('success');
};
```

### 5.3 æ€§èƒ½æµ‹è¯•

#### 5.3.1 å¤§æ•°æ®é‡æµ‹è¯•
```javascript
// æµ‹è¯•å¤§æ•°æ®é‡æ¸…ç†æ€§èƒ½
const performanceTest = async () => {
  const startTime = Date.now();
  
  // åˆ›å»ºå¤§é‡æµ‹è¯•æ•°æ®
  await createTestRecords(10000);
  
  // æ‰§è¡Œæ¸…ç†
  await sscLotteryService.cleanupHistoryRecords();
  
  const duration = Date.now() - startTime;
  console.log(`æ¸…ç†10000æ¡è®°å½•è€—æ—¶: ${duration}ms`);
  
  // éªŒè¯æ€§èƒ½è¦æ±‚ï¼ˆåº”åœ¨5ç§’å†…å®Œæˆï¼‰
  expect(duration).toBeLessThan(5000);
};
```

## 6. è¿ç»´æŒ‡å—

### 6.1 ç›‘æ§æŒ‡æ ‡

#### 6.1.1 å…³é”®æŒ‡æ ‡
- **å†å²è®°å½•æ€»æ•°**ï¼šç›‘æ§æ˜¯å¦è¶…è¿‡è®¾å®šé˜ˆå€¼
- **æ¸…ç†ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€**ï¼šç›‘æ§å®šæ—¶ä»»åŠ¡æ˜¯å¦æ­£å¸¸æ‰§è¡Œ
- **æ¸…ç†è€—æ—¶**ï¼šç›‘æ§æ¸…ç†æ“ä½œçš„æ€§èƒ½
- **å¤‡ä»½æ•°æ®é‡**ï¼šç›‘æ§å½’æ¡£è¡¨çš„å¢é•¿æƒ…å†µ

#### 6.1.2 å‘Šè­¦è®¾ç½®
```javascript
// å‘Šè­¦è§„åˆ™ç¤ºä¾‹
const alertRules = {
  historyRecordsThreshold: 100, // å†å²è®°å½•è¶…è¿‡100æœŸæ—¶å‘Šè­¦
  cleanupFailureAlert: true, // æ¸…ç†å¤±è´¥æ—¶ç«‹å³å‘Šè­¦
  cleanupDurationThreshold: 30, // æ¸…ç†è€—æ—¶è¶…è¿‡30ç§’æ—¶å‘Šè­¦
  archiveGrowthRate: 1000 // å½’æ¡£æ•°æ®æ¯æ—¥å¢é•¿è¶…è¿‡1000æ¡æ—¶å‘Šè­¦
};
```

### 6.2 æ•…éšœå¤„ç†

#### 6.2.1 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1ï¼šæ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥**
```sql
-- æŸ¥çœ‹é”™è¯¯æ—¥å¿—
SELECT * FROM ssc_cron_logs 
WHERE task_type = 'cleanup_history' 
  AND status = 'failed' 
ORDER BY start_time DESC LIMIT 5;

-- æ‰‹åŠ¨æ‰§è¡Œæ¸…ç†
SELECT * FROM cleanup_ssc_history_records(40, true);
```

**é—®é¢˜2ï¼šæ¸…ç†åæ•°æ®å¼‚å¸¸**
```sql
-- ä»å½’æ¡£è¡¨æ¢å¤æ•°æ®
INSERT INTO ssc_lottery_results (
  issue_no, issue_date, wan_wei, qian_wei, bai_wei, 
  shi_wei, ge_wei, winning_numbers, open_time, status
)
SELECT 
  issue_no, issue_date, wan_wei, qian_wei, bai_wei,
  shi_wei, ge_wei, winning_numbers, open_time, status
FROM ssc_lottery_results_archive
WHERE archived_at > '2024-12-20 00:00:00';
```

**é—®é¢˜3ï¼šå½’æ¡£è¡¨æ•°æ®è¿‡å¤š**
```sql
-- æ¸…ç†è¶…è¿‡30å¤©çš„å½’æ¡£æ•°æ®
DELETE FROM ssc_lottery_results_archive
WHERE archived_at < CURRENT_DATE - INTERVAL '30 days';
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

#### 6.3.1 æ•°æ®åº“ä¼˜åŒ–
```sql
-- å®šæœŸåˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE ssc_lottery_results;
ANALYZE ssc_lottery_results_archive;

-- é‡å»ºç´¢å¼•ï¼ˆå¦‚æœå¿…è¦ï¼‰
REINDEX TABLE ssc_lottery_results;
REINDEX TABLE ssc_lottery_results_archive;
```

#### 6.3.2 æ¸…ç†ä¼˜åŒ–
```javascript
// åˆ†æ‰¹æ¸…ç†å¤§é‡æ•°æ®
const batchCleanup = async (batchSize = 1000) => {
  let totalCleaned = 0;
  let hasMore = true;
  
  while (hasMore) {
    const result = await pool.query(`
      DELETE FROM ssc_lottery_results
      WHERE id IN (
        SELECT id FROM ssc_lottery_results
        WHERE status = 'drawn'
          AND id < (
            SELECT MIN(id) FROM (
              SELECT id FROM ssc_lottery_results
              WHERE status = 'drawn'
              ORDER BY open_time DESC
              LIMIT $1
            ) recent
          )
        LIMIT $2
      )
    `, [this.config.historyRetentionCount, batchSize]);
    
    totalCleaned += result.rowCount;
    hasMore = result.rowCount === batchSize;
    
    // é¿å…é•¿æ—¶é—´é”è¡¨
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  return totalCleaned;
};
```

## 7. å®æ–½éªŒè¯

### 7.1 éƒ¨ç½²ç»“æœ
âœ… **æ•°æ®åº“è¿ç§»æˆåŠŸ**ï¼š
- æˆåŠŸåˆ›å»ºå½’æ¡£è¡¨ `ssc_lottery_results_archive`
- æˆåŠŸåˆ›å»ºæ¸…ç†å†å²è¡¨ `ssc_cleanup_history`
- æˆåŠŸæ·»åŠ 8ä¸ªç³»ç»Ÿé…ç½®é¡¹
- æˆåŠŸåˆ›å»º7ä¸ªç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- æˆåŠŸåˆ›å»ºæ¸…ç†å‡½æ•°ã€ç»Ÿè®¡å‡½æ•°ã€å®Œæ•´æ€§æ£€æŸ¥å‡½æ•°

âœ… **æœåŠ¡åŠŸèƒ½éªŒè¯**ï¼š
- å†å²è®°å½•ç»Ÿè®¡åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- æ•°æ®å®Œæ•´æ€§æ£€æŸ¥åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- å†å²è®°å½•æ±‡æ€»åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- æ¸…ç†çŠ¶æ€æ£€æŸ¥åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- æ‰‹åŠ¨æ¸…ç†åŠŸèƒ½æ­£å¸¸è¿è¡Œï¼ˆæˆåŠŸæ¸…ç†544æ¡è®°å½•ï¼Œå¤‡ä»½544æ¡ï¼‰
- æ¸…ç†å†å²è®°å½•åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- ç³»ç»Ÿé…ç½®åŠŸèƒ½æ­£å¸¸è¿è¡Œ

âœ… **APIæ¥å£éªŒè¯**ï¼š
- `/api/admin/lottery/history-stats` - è·å–å†å²è®°å½•ç»Ÿè®¡
- `/api/admin/lottery/cleanup-history` - æ‰‹åŠ¨æ¸…ç†å†å²è®°å½•
- `/api/admin/lottery/cleanup-logs` - è·å–æ¸…ç†æ—¥å¿—
- `/api/admin/lottery/history-summary` - è·å–å†å²è®°å½•æ±‡æ€»
- `/api/admin/lottery/data-integrity` - éªŒè¯æ•°æ®å®Œæ•´æ€§
- `/api/admin/lottery/cleanup-archive` - æ¸…ç†å½’æ¡£æ•°æ®
- `/api/admin/lottery/cleanup-status` - æ£€æŸ¥æ¸…ç†çŠ¶æ€

### 7.2 æµ‹è¯•ç»“æœæ‘˜è¦
```
ğŸ§ª åˆ†åˆ†æ—¶æ—¶å½©å†å²è®°å½•ç®¡ç†åŠŸèƒ½æµ‹è¯•ç»“æœ:

ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€:
- å½“å‰è®°å½•æ€»æ•°: 40æœŸï¼ˆæ¸…ç†åï¼‰
- å·²å¼€å¥–è®°å½•: 40æœŸ
- å¾…å¼€å¥–è®°å½•: 0æœŸ
- ä»Šæ—¥è®°å½•: 7æœŸ
- å½’æ¡£è®°å½•æ•°: 544æœŸ
- å½’æ¡£è¡¨å¤§å°: 0.05MB

ğŸ§¹ æ¸…ç†æ‰§è¡Œç»“æœ:
- æ¸…ç†è®°å½•æ•°: 544æœŸ
- å¤‡ä»½è®°å½•æ•°: 544æœŸ
- ä¿ç•™æœ€æ–°æœŸå·: 202507011612
- ä¿ç•™æœ€æ—§æœŸå·: 202507011452
- æ‰§è¡Œè€—æ—¶: <1ç§’

âš™ï¸ ç³»ç»Ÿé…ç½®:
- å†å²ä¿ç•™æœŸæ•°: 40æœŸ
- è‡ªåŠ¨æ¸…ç†: å·²å¯ç”¨
- æ¸…ç†æ—¶é—´: æ¯æ—¥00:05
- å¤‡ä»½åŠŸèƒ½: å·²å¯ç”¨
- å½’æ¡£ä¿ç•™: 30å¤©
- å®‰å…¨æ£€æŸ¥: å·²å¯ç”¨
```

### 7.3 æ€§èƒ½ä¼˜åŒ–æ•ˆæœ
- **å­˜å‚¨ç©ºé—´å‡å°‘**: ä»584æœŸå‡å°‘åˆ°40æœŸï¼ŒèŠ‚çœ93%å­˜å‚¨ç©ºé—´
- **æŸ¥è¯¢æ€§èƒ½æå‡**: å†å²æ•°æ®å‡å°‘ï¼ŒæŸ¥è¯¢é€Ÿåº¦æ˜¾è‘—æå‡
- **ç³»ç»Ÿè´Ÿè½½é™ä½**: å‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæé«˜æ•´ä½“æ€§èƒ½
- **ç»´æŠ¤æˆæœ¬é™ä½**: è‡ªåŠ¨åŒ–æ¸…ç†ï¼Œå‡å°‘äººå·¥ç»´æŠ¤å·¥ä½œ

## 8. æ€»ç»“

### 8.1 å®ç°æ•ˆæœ
- âœ… **å­˜å‚¨ä¼˜åŒ–**ï¼šæ¯æ—¥åªä¿ç•™30-50æœŸå†å²è®°å½•ï¼Œå¤§å¹…å‡å°‘å­˜å‚¨ç©ºé—´ï¼ˆèŠ‚çœ93%ï¼‰
- âœ… **æ€§èƒ½æå‡**ï¼šå‡å°‘å†å²æ•°æ®ï¼Œæé«˜æŸ¥è¯¢å’Œç»Ÿè®¡æ€§èƒ½
- âœ… **è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šå®šæ—¶è‡ªåŠ¨æ¸…ç†ï¼ˆæ¯æ—¥00:05ï¼‰ï¼Œæ— éœ€äººå·¥å¹²é¢„
- âœ… **æ•°æ®å®‰å…¨**ï¼šæ¸…ç†å‰è‡ªåŠ¨å¤‡ä»½ï¼Œæ”¯æŒæ•°æ®æ¢å¤ï¼ˆå·²éªŒè¯544æœŸå¤‡ä»½æˆåŠŸï¼‰
- âœ… **å¯é…ç½®æ€§**ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´ä¿ç•™æœŸæ•°å’Œæ¸…ç†ç­–ç•¥
- âœ… **ç›‘æ§å®Œå–„**ï¼šå®Œæ•´çš„æ¸…ç†æ—¥å¿—å’Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### 8.2 æŠ€æœ¯ç‰¹ç‚¹
- **å®‰å…¨å¯é **ï¼šå¤šé‡å®‰å…¨æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œå·²é€šè¿‡å®é™…æµ‹è¯•éªŒè¯
- **é«˜æ€§èƒ½**ï¼šä¼˜åŒ–çš„æ¸…ç†ç®—æ³•ï¼Œæ”¯æŒå¤§æ•°æ®é‡å¤„ç†ï¼ˆ544æœŸ<1ç§’å®Œæˆï¼‰
- **æ˜“ç»´æŠ¤**ï¼šå®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç›‘æ§ä½“ç³»ï¼Œæ”¯æŒAPIç®¡ç†
- **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºåŠŸèƒ½æ‰©å±•

### 8.3 éƒ¨ç½²çŠ¶æ€
- **ç”Ÿäº§å°±ç»ª**ï¼šæ‰€æœ‰åŠŸèƒ½å·²æµ‹è¯•é€šè¿‡ï¼Œå¯å®‰å…¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- **å®šæ—¶ä»»åŠ¡**ï¼šå·²é…ç½®æ¯æ—¥å‡Œæ™¨è‡ªåŠ¨æ¸…ç†
- **ç›‘æ§å‘Šè­¦**ï¼šå·²é…ç½®å†å²è®°å½•è¿‡å¤šæ—¶çš„è‡ªåŠ¨æ£€æŸ¥
- **APIç®¡ç†**ï¼šç®¡ç†å‘˜å¯é€šè¿‡APIæ‰‹åŠ¨è§¦å‘æ¸…ç†å’ŒæŸ¥çœ‹çŠ¶æ€

### 8.4 åç»­è§„åˆ’
- **ç»Ÿè®¡åˆ†æ**ï¼šåŸºäºå½’æ¡£æ•°æ®è¿›è¡Œé•¿æœŸè¶‹åŠ¿åˆ†æ
- **æ™ºèƒ½æ¸…ç†**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´æ¸…ç†ç­–ç•¥
- **å¤šçº§å½’æ¡£**ï¼šå®ç°æ›´ç²¾ç»†çš„æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **äº‘ç«¯å¤‡ä»½**ï¼šå°†å½’æ¡£æ•°æ®å¤‡ä»½åˆ°äº‘å­˜å‚¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024-12-20  
**æ›´æ–°æ—¶é—´**: 2024-12-20  
**å®æ–½çŠ¶æ€**: âœ… å·²å®Œæˆéƒ¨ç½²å¹¶éªŒè¯  
**ä½œè€…**: ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ 